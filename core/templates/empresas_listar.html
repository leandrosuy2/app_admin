{% extends 'base.html' %}
{% load custom_filters bool_filters %}

{% block content %}
<!-- CSRF disponível para o JS -->
<form id="csrf-holder" style="display:none;">{% csrf_token %}</form>

<div class="container mt-5">
  <h3 class="text-center mb-4 fw-bold" style="font-size:22px;color:#3498db;text-transform:uppercase;letter-spacing:1px;">
    <i class="fas fa-building me-2" style="color:#2980b9;"></i> Lista de Empresas
  </h3>

  <div class="mb-3 d-flex justify-content-between align-items-center gap-2 flex-wrap">
    <form method="GET" class="d-flex gap-2">
      <input type="text" name="q" class="form-control form-control-sm" placeholder="Pesquisar..." value="{{ query }}">
      <button type="submit" class="btn btn-sm btn-primary">Pesquisar</button>
    </form>
    <a href="{% url 'adicionar_empresa' %}" class="btn btn-sm btn-success">Adicionar Empresa</a>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered text-center table-sm align-middle" style="font-size:.9rem;">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Razão Social</th>
          <th>Nome Fantasia</th>
          <th>CNPJ</th>
          <th>Status</th>
          <th style="min-width:360px;">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for empresa in page_obj %}
        <tr class="{% if not empresa.status_empresa|as_bool %}bg-warning text-dark{% endif %}">
          <td><b>{{ empresa.id }}</b></td>
          <td><b>{{ empresa.razao_social }}</b></td>
          <td><b>{{ empresa.nome_fantasia }}</b></td>
          <td><b>{{ empresa.cnpj }}</b></td>

          <td>
            <span class="status-text fw-bold {% if empresa.status_empresa|as_bool %}text-success{% else %}text-danger{% endif %}">
              {% if empresa.status_empresa|as_bool %}Ativada{% else %}Desativada{% endif %}
            </span>
            <button type="button"
                    class="btn btn-sm ms-2 toggle-status {% if empresa.status_empresa|as_bool %}btn-danger{% else %}btn-success{% endif %}"
                    data-url="{% url 'alterar_status_empresa' empresa.id %}"
                    style="min-width: 80px;">
              {% if empresa.status_empresa|as_bool %}Desativar{% else %}Ativar{% endif %}
            </button>
          </td>

          <td>
            <div class="d-flex justify-content-center gap-1 flex-nowrap" style="min-width:350px;">
              <a href="{% url 'gerar_contrato_lojista' empresa.id %}"
                 class="btn btn-sm btn-warning text-white fw-bold shadow-sm"
                 target="_blank" style="min-width:80px;">
                <i class="fas fa-file-signature me-1"></i> Contrato
              </a>

              {% comment "Oculto por enquanto" %}
              <a href="{% url 'gerar_ficha_lojista' empresa.id %}"
                 class="btn btn-sm btn-primary text-white fw-bold shadow-sm"
                 target="_blank" style="min-width:80px;">
                <i class="fas fa-file-alt me-1"></i> Ficha
              </a>
              {% endcomment %}

              <a href="{% url 'editar_empresa' empresa.id %}"
                 class="btn btn-sm btn-success text-white fw-bold shadow-sm"
                 style="min-width:80px;">
                <i class="fas fa-edit me-1"></i> Editar
              </a>

              <a href="{% url 'excluir_empresa' empresa.id %}"
                 class="btn btn-sm btn-danger text-white fw-bold shadow-sm"
                 style="min-width:80px;">
                <i class="fas fa-trash-alt me-1"></i> Excluir
              </a>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="6">Nenhuma empresa encontrada.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-2">
    <div>
      {% if page_obj.has_previous %}
        <a href="?page=1{% if query %}&q={{ query|urlencode }}{% endif %}" class="btn btn-sm btn-primary">Primeira</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}" class="btn btn-sm btn-secondary">Anterior</a>
      {% endif %}
    </div>
    <div>
      <span class="fw-bold">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    </div>
    <div>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}" class="btn btn-sm btn-secondary">Próxima</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query|urlencode }}{% endif %}" class="btn btn-sm btn-primary">Última</a>
      {% endif %}
    </div>
  </div>
</div>

<script>
// CSRF vindo do DOM (não depende de cookie JS)
function getCSRF(){
  const el = document.querySelector('#csrf-holder input[name=csrfmiddlewaretoken]');
  return el ? el.value : '';
}

document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".toggle-status").forEach(button => {
    button.addEventListener("click", function () {
      const url = this.getAttribute("data-url");
      const btn = this;
      const td = btn.closest('td');
      const tr = btn.closest('tr');
      const statusText = td.querySelector(".status-text");

      btn.disabled = true;
      const originalText = btn.textContent.trim();
      btn.textContent = '...';

      fetch(url, {
        method: "POST",
        credentials: "same-origin",
        headers: {
          "X-CSRFToken": getCSRF(),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({}) // toggle no backend
      })
      .then(async r => {
        if (!r.ok) {
          const txt = await r.text();
          console.error('Falha no toggle:', r.status, txt);
          throw new Error('HTTP ' + r.status);
        }
        return r.json();
      })
      .then(data => {
        if (data.success) {
          const ativo = !!data.status_empresa;

          // Atualiza texto/status
          statusText.textContent = ativo ? "Ativada" : "Desativada";
          statusText.classList.toggle("text-success", ativo);
          statusText.classList.toggle("text-danger", !ativo);

          // Botão
          btn.classList.toggle("btn-danger", ativo);
          btn.classList.toggle("btn-success", !ativo);
          btn.textContent = ativo ? "Desativar" : "Ativar";

          // Linha amarela quando desativada
          tr.classList.toggle("bg-warning", !ativo);
          tr.classList.toggle("text-dark", !ativo);
        } else {
          alert("Erro ao alterar o status.");
          btn.textContent = originalText;
        }
      })
      .catch(() => {
        alert("Erro de comunicação.");
        btn.textContent = originalText;
      })
      .finally(() => { btn.disabled = false; });
    });
  });
});
</script>
{% endblock %}
