{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-4">Lista de Usuários Lojistas</h1>

  <!-- Busca -->
  <form method="get" class="mb-3">
    <div class="input-group">
      <input type="text" name="q" class="form-control"
             placeholder="Pesquisar por nome, email ou empresa" value="{{ query }}">
      <button type="submit" class="btn btn-primary">Pesquisar</button>
    </div>
  </form>

  <a href="{% url 'usuarios_lojista_criar' %}" class="btn btn-primary mb-3">Criar Novo Lojista</a>

  <!-- Exclusão em massa -->
  <form id="form-mass-delete"
        method="post"
        action="{% url 'excluir_lojistas_em_massa' %}"
        onsubmit="return confirm('Excluir todos os selecionados?');">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ request.get_full_path }}">

    <div class="mb-2 d-flex gap-2">
      <button type="submit" id="btn-mass-delete" class="btn btn-danger btn-sm" disabled>
        <i class="fas fa-trash"></i> Excluir selecionados
      </button>
    </div>

    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th style="width:36px;">
            <input type="checkbox" id="select-all">
          </th>
          <th>Nome</th>
          <th>Email</th>
          <th>Empresa</th>
          <th style="width:220px">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in page_obj %}
          <tr>
            <td>
              <input type="checkbox" class="chk-id" name="ids" value="{{ usuario.id }}">
            </td>
            <td>{{ usuario.name }}</td>
            <td>{{ usuario.email }}</td>
            <td>{{ usuario.empresa.razao_social }}</td>
            <td>
              <a href="{% url 'usuarios_lojista_editar' usuario.id %}" class="btn btn-warning btn-sm">
                Editar
              </a>

              <!-- Exclusão individual (POST + redirect) -->
              <form method="post"
                    action="{% url 'excluir_lojista' usuario.id %}?next={{ request.get_full_path|urlencode }}"
                    style="display:inline"
                    onsubmit="return confirm('Confirma a exclusão deste registro?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="text-center">Nenhum usuário encontrado.</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="mt-2">
      <button type="submit" id="btn-mass-delete-bottom" class="btn btn-danger btn-sm" disabled>
        <i class="fas fa-trash"></i> Excluir selecionados
      </button>
    </div>
  </form>

  <!-- Paginação -->
  <nav class="mt-3">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?q={{ query }}&page=1">Primeira</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?q={{ query }}&page={{ page_obj.previous_page_number }}">Anterior</a>
        </li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
          <a class="page-link" href="?q={{ query }}&page={{ num }}">{{ num }}</a>
        </li>
      {% endfor %}

      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?q={{ query }}&page={{ page_obj.next_page_number }}">Próxima</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?q={{ query }}&page={{ page_obj.paginator.num_pages }}">Última</a>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>

<script>
  // Selecionar todos + habilitar/desabilitar botão
  document.addEventListener('DOMContentLoaded', function () {
    const selAll = document.getElementById('select-all');
    const massBtns = [document.getElementById('btn-mass-delete'),
                      document.getElementById('btn-mass-delete-bottom')];

    function checks() {
      return Array.from(document.querySelectorAll('.chk-id'));
    }
    function updateButtons() {
      const anyChecked = checks().some(c => c.checked);
      massBtns.forEach(b => b && (b.disabled = !anyChecked));
    }

    if (selAll) {
      selAll.addEventListener('change', function () {
        checks().forEach(c => c.checked = selAll.checked);
        updateButtons();
      });
    }
    checks().forEach(c => c.addEventListener('change', updateButtons));
    updateButtons();
  });
</script>
{% endblock %}
