{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h3 class="text-center mb-4 fw-bold" style="font-size: 20px; color: #2c3e50; text-transform: uppercase; letter-spacing: 1px;">
    

    <i class="fas fa-users me-2" style="color: #3498db;"></i> Lista de Devedores
</h3>

    <div class="d-flex gap-2 flex-wrap justify-content-start mb-2">
  <span class="badge bg-warning text-dark">Pendente: {{ totals.pendentes|default:0 }}</span>
  <span class="badge bg-info text-dark">Negociado: {{ totals.negociados|default:0 }}</span>
  <span class="badge bg-success">Quitado: {{ totals.quitados|default:0 }}</span>
  <span class="badge bg-secondary">Total: {{ totals.total|default:0 }}</span>
</div>
    <!-- Botão para adicionar novo devedor -->
   
	<div class="container mt-5">
    <div class="text-end mb-3 d-flex justify-content-end gap-2">
        <!-- Botão Consultar API -->
        <button id="consult-api-btn" class="btn btn-sm btn-primary d-flex align-items-center" style="font-size: 14px; padding: 6px 12px;">
            <i class="fas fa-search me-2"></i> Consultar API
        </button>

        <!-- Botão Adicionar Devedor -->
        <a href="{% url 'adicionar_devedor' %}" class="btn btn-sm btn-success d-flex align-items-center" style="font-size: 14px; padding: 6px 12px;">
            <i class="fas fa-user-plus me-2"></i> Adicionar Devedor
        </a>

        <!-- Botão Baixar Modelo -->
        <a href="{% url 'baixar_modelo_devedor' %}" class="btn btn-sm btn-info d-flex align-items-center" style="font-size: 14px; padding: 6px 12px;">
            <i class="fas fa-download me-2"></i> Baixar Modelo
        </a>

        <!-- Botão Importar Devedor -->
        <button class="btn btn-sm btn-primary d-flex align-items-center" style="font-size: 14px; padding: 6px 12px;" data-bs-toggle="modal" data-bs-target="#importarModal">
            <i class="fas fa-file-upload me-2"></i> Importar Devedor
        </button>
    </div>
</div>


    <!-- Modal de Importação -->
    <div class="modal fade" id="importarModal" tabindex="-1" aria-labelledby="importarModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" action="{% url 'importar_devedor' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="importarModalLabel">Importar Devedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <label for="arquivo" class="form-label">Selecione a planilha:</label>
                        <input type="file" name="arquivo" id="arquivo" class="form-control" required>
                        <div class="form-text mt-2">
                            Certifique-se de usar o modelo correto para importar.
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Importar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Campo de pesquisa e filtros -->
    <div class="mb-2">
        <form method="get" action="{% url 'listar_devedores' %}" class="d-flex flex-wrap gap-2 align-items-center" style="font-size: 12px;">
            <div class="flex-grow-1">
                <input type="text" name="q" value="{{ query }}" class="form-control form-control-sm" placeholder="Pesquisar por nome, CPF, CNPJ, telefone, etc.">
            </div>
            <div>
                <button type="submit" name="status" value="" class="btn btn-sm {% if not status %}btn-secondary{% else %}btn-outline-secondary{% endif %}" style="font-size: 12px; padding: 4px 8px;">
                    Pesquisar
                </button>
              <button type="submit" name="status" value="Pendente"
  class="btn btn-sm {% if status == 'Pendente' %}btn-warning{% else %}btn-outline-warning{% endif %}">
  Pendente ({{ totals.pendentes|default:0 }})
</button>
<button type="submit" name="status" value="Quitado"
  class="btn btn-sm {% if status == 'Quitado' %}btn-success{% else %}btn-outline-success{% endif %}">
  Quitado ({{ totals.quitados|default:0 }})
</button>
<button type="submit" name="status" value="Negociado"
  class="btn btn-sm {% if status == 'Negociado' %}btn-info{% else %}btn-outline-info{% endif %}">
  Negociado ({{ totals.negociados|default:0 }})
</button>

            </div>
        </form>
    </div>

    <!-- Tabela de devedores -->
    <table class="table table-striped table-bordered text-center table-sm" style="font-size: 0.9rem;">
        <thead class="table-dark">
            <tr>
				<th><input type="checkbox" id="select-all"></th>	
                <th style="padding: 5px;">ID</th>
                <th style="padding: 5px;">Nome</th>
                <th style="padding: 5px;">CPF / CNPJ</th>                
                <th style="padding: 5px;">Empresa</th>
                <th style="padding: 5px;">Título ID</th>
                <th style="padding: 5px;">Status Baixa</th>
                <th style="padding: 5px;">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% if page_obj and page_obj.object_list %}
                {% for devedor in page_obj %}
                <tr>
					<td><input type="checkbox" class="devedor-checkbox" value="{{ devedor.id }}"></td>
                    <td><b>{{ devedor.id }}</b></td>
                    <td class="text-start">
						         <b>
					{% if devedor.nome %}
						{{ devedor.nome }}
					{% elif devedor.nome_fantasia %}
						{{ devedor.nome_fantasia }}
					{% endif %}
				</b>
					</td>

                    <td><b>
						{% if devedor.cpf %}
							{{ devedor.cpf }}
						{% elif devedor.cnpj %}
							{{ devedor.cnpj }}
						{% else %}
							Não informado
						{% endif %}
					</b></td>
                    
                    <td><b>{{ devedor.empresa }}</b></td>
                    <td><b>{{ devedor.titulo_id }}</b></td>
                    <td><b>
                        {% if devedor.status_baixa == "Pendente" %}
                            <span class="badge bg-warning text-dark" style="font-size: 10px;">Pendente</span>
                        {% elif devedor.status_baixa == "Quitado" %}
                            <span class="badge bg-success" style="font-size: 10px;">Quitado</span>
                        {% elif devedor.status_baixa == "Negociado" %}
                            <span class="badge bg-info" style="font-size: 10px;">Negociado</span>
                        {% else %}
                            <span class="badge bg-secondary" style="font-size: 10px;">Desconhecido</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="d-flex justify-content-center gap-1">
						<div class="d-flex justify-content-center gap-1">

  {# Visualizar, Editar, Excluir, Ver Títulos ... (o que já existe) #}

  {# --- NOVO: Refazer (voltar para Pendente) --- #}
  {% if devedor.status_baixa != "Pendente" %}
  <form method="post"
        action="{% url 'refazer_devedor' devedor.id %}"
        class="d-inline"
        onsubmit="return confirm('Isso vai APAGAR a negociação/baixa e voltar TODOS os títulos deste devedor para PENDENTE. Continuar?');">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <button type="submit" class="btn btn-sm btn-outline-warning" style="font-size:10px;padding:2px 6px;">
        <i class="fas fa-rotate-left"></i> Refazer
      </button>
  </form>
  {% endif %}

</div>

						
							{% if devedor.titulo_id %}
  <a href="{% url 'detalhes_devedor' devedor.titulo_id %}" target="_blank" class="btn btn-sm btn-info">Visualizar</a>
{% else %}
  <button class="btn btn-sm btn-info" disabled>Visualizar</button>
{% endif %}
                            
                            <a href="{% url 'editar_devedor' devedor.id %}" class="btn btn-sm btn-primary" style="font-size: 10px; padding: 2px 6px;">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                            <form method="post" action="{% url 'excluir_devedor' devedor.id %}" class="d-inline">
  {% csrf_token %}
  <button type="submit" class="btn btn-sm btn-danger" style="font-size:10px;padding:2px 6px;">
    <i class="fas fa-trash"></i> Excluir
  </button>
</form>

                            <a href="{% url 'listar_titulos_por_devedor' devedor.id %}" class="btn btn-sm btn-info" style="font-size: 10px; padding: 2px 6px;">
                                <i class="fas fa-eye"></i> Ver Títulos
                            </a>
                            
                            <!-- Botão Trocar Operador -->
                            <button type="button" class="btn btn-sm btn-warning" style="font-size: 10px; padding: 2px 6px;" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalTrocarOperador{{ devedor.id }}"
                                    title="Trocar Operador">
                                <i class="fas fa-user-edit"></i> Operador
                            </button>
                        </div>
                    </td>
                </tr>
                
                <!-- Modal para Trocar Operador -->
                <div class="modal fade" id="modalTrocarOperador{{ devedor.id }}" tabindex="-1" aria-labelledby="modalTrocarOperadorLabel{{ devedor.id }}" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="modalTrocarOperadorLabel{{ devedor.id }}">
                                    Trocar Operador - Devedor #{{ devedor.id }}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <form id="formTrocarOperador{{ devedor.id }}" method="post" action="{% url 'alterar_operador_devedor' devedor.id %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="operador{{ devedor.id }}" class="form-label">Selecione o Operador:</label>
                                        <select class="form-select" id="operador{{ devedor.id }}" name="operador" required>
                                            <option value="">-- Selecione um operador --</option>
                                            {% for operador in operadores %}
                                                <option value="{{ operador.username }}">
                                                    {{ operador.get_full_name|default:operador.username }}
                                                    {% if operador.get_full_name %} ({{ operador.username }}){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="alert alert-info">
                                        <small><i class="fas fa-info-circle"></i> Esta ação alterará o operador de todos os títulos deste devedor.</small>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-save"></i> Salvar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <tr>
                <td colspan="8" class="text-center">Nenhum devedor encontrado.</td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <!-- Paginação -->
   <div class="d-flex justify-content-between align-items-center mt-2" style="font-size: 12px;">
    <div>
        {% if page_obj.has_previous %}
            <a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if status %}&status={{ status }}{% endif %}" 
               class="btn btn-sm btn-primary" style="font-size: 10px; padding: 2px 6px;">
                <i class="fas fa-angle-double-left"></i> Primeira
            </a>
            <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if status %}&status={{ status }}{% endif %}" 
               class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 2px 6px;">
                <i class="fas fa-angle-left"></i> Anterior
            </a>
        {% endif %}
    </div>
    <div>
        <span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    </div>
    <div>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if status %}&status={{ status }}{% endif %}" 
               class="btn btn-sm btn-secondary" style="font-size: 10px; padding: 2px 6px;">
                Próxima <i class="fas fa-angle-right"></i>
            </a>
            <a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if status %}&status={{ status }}{% endif %}" 
               class="btn btn-sm btn-primary" style="font-size: 10px; padding: 2px 6px;">
                Última <i class="fas fa-angle-double-right"></i>
            </a>
        {% endif %}
    </div>
</div>
<script>
    document.getElementById('select-all').addEventListener('change', function() {
        let checkboxes = document.querySelectorAll('.devedor-checkbox');
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    });

    document.getElementById('consult-api-btn').addEventListener('click', function() {
        let selectedDevedores = [];
        let checkboxes = document.querySelectorAll('.devedor-checkbox:checked');
        checkboxes.forEach(checkbox => selectedDevedores.push(checkbox.value));

        if (selectedDevedores.length === 0) {
            alert('Selecione pelo menos um devedor para consultar a API.');
            return;
        }

        fetch('{% url "consult_api" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({devedores: selectedDevedores})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Dados atualizados com sucesso.');
                window.location.reload();
            } else {
                alert('Erro ao atualizar dados: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao consultar a API.');
        });
    });
    
    // Handler para formulários de trocar operador
    document.querySelectorAll('[id^="formTrocarOperador"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const devedorId = this.action.match(/devedor\/(\d+)\//)[1];
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert(data.message);
                    // Fechar o modal usando Bootstrap 5
                    const modalElement = document.getElementById('modalTrocarOperador' + devedorId);
                    if (modalElement) {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        } else {
                            // Se não existe instância, criar e fechar
                            const newModal = new bootstrap.Modal(modalElement);
                            newModal.hide();
                        }
                    }
                    // Recarregar a página para atualizar os dados
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    alert('Erro: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao alterar operador.');
            });
        });
    });
</script>
{% endblock %}
