{% extends 'base.html' %}
{% block content %}

<div class="container mt-5">
  <h3 class="text-center mb-4" style="font-size: 18px;"><b>Lista de Títulos / Acordos</b></h3>

  <!-- Busca -->
  <form method="get" action="{% url 'acordos_listar' %}" class="mb-3 d-flex gap-2" style="font-size: 12px;">
    <input type="text" name="q" value="{{ query }}" class="form-control form-control-sm"
           placeholder="Pesquisar por devedor, empresa, CPF, CNPJ, etc.">
    <button type="submit" class="btn btn-sm btn-primary" style="font-size: 12px;">Pesquisar</button>
  </form>

  <!-- Tabela -->
  <table class="table table-striped table-bordered text-center table-sm" style="font-size: .9rem;">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Devedor</th>
        <th>CPF / CNPJ</th>
        <th>Empresa</th>
        <th>Valor Recebido</th>
        <th>Data Baixa</th>
        <th>Parcelas</th>
        <th>Total do Acordo</th>
        <th>1ª Parcela</th>
        <th>Contato</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody>
      {% for titulo in page_obj %}
      <tr>
        <td>{{ titulo.titulo_id }}</td>
        <td>{{ titulo.devedor_nome }}</td>
        <td>{{ titulo.cpf|default_if_none:titulo.cnpj }}</td>
        <td>{{ titulo.empresa_nome }}</td>
        <td>R$ {{ titulo.valorRecebido|floatformat:2 }}</td>
        <td>{{ titulo.data_baixa|default:"-" }}</td>
        <td>{{ titulo.qtde_parcelas|default:"-" }}</td>
        <td>R$ {{ titulo.total_acordo|floatformat:2 }}</td>
        <td>{{ titulo.dataVencimentoPrimeira|default:"-" }}</td>
        <td>{{ titulo.contato }}</td>
        <td>
          <button class="btn btn-sm btn-info" onclick="toggleParcelas({{ titulo.titulo_id }})">Ver Parcelas</button>
          <a href="{% url 'gerar_contrato' titulo.titulo_id %}" class="btn btn-sm btn-success" target="_blank">Gerar Contrato</a>
        </td>
      </tr>

      <!-- LINHA DAS PARCELAS -->
      <tr id="parcelas-{{ titulo.titulo_id }}" class="d-none">
        <td colspan="11">
          <h6 class="mb-2" style="font-size: 12px;">Parcelas</h6>
          <div class="table-responsive">
            <table class="table table-bordered table-sm mb-0">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Valor</th>
                  <th>Vencimento</th>
                  <th>Pagamento</th>
                  <th>Status</th>
                  <th class="text-start">Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for parcela in titulo.parcelas %}
                <tr style="{% if parcela.status_baixa == 2 %}background-color:#98fb98;{% endif %}">
                  <td>{{ parcela.id }}</td>
                  <td>R$ {{ parcela.valor|floatformat:2 }}</td>
                  <td>{{ parcela.data_vencimento_br }}</td>
                  <td>{{ parcela.data_baixa_br|default:"-" }}</td>
                  <td>
                    {% if parcela.status_baixa == 2 %}Quitado
                    {% elif parcela.status_baixa == 3 %}Negociado
                    {% else %}Pendente{% endif %}
                  </td>
                  <td class="text-start">
                    {# --- seus botões existentes --- #}
                    {% if parcela.status_baixa == 2 %}
                      <a href="{% url 'gerar_recibo' parcela.id %}" class="btn btn-sm btn-secondary" target="_blank">Recibo</a>
                      {% if parcela.comprovante %}
                        <a href="{{ parcela.comprovante.url }}" class="btn btn-sm btn-info" target="_blank">Baixar Comprovante</a>
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalAnexarComprovante{{ parcela.id }}">Alterar Comprovante</button>
                      {% else %}
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalAnexarComprovante{{ parcela.id }}">Anexar Comprovante</button>
                      {% endif %}
                    {% endif %}
                    {% if parcela.status_baixa == 2 or parcela.status_baixa == 3 %}
                      {% if titulo.titulo_id %}
                        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalAnexarContrato{{ titulo.titulo_id }}">Anexar Contrato</button>
                      {% endif %}
                      {% if titulo.contrato %}
                        <a href="{% url 'baixar_contrato' titulo.titulo_id %}" class="btn btn-sm btn-secondary" target="_blank">Baixar Contrato</a>
                      {% endif %}
                    {% endif %}

                    {# --- NOVOS: Editar / Excluir (sempre visíveis) --- #}
                    <button type="button"
                            class="btn btn-sm btn-warning"
                            data-bs-toggle="modal"
                            data-bs-target="#modalEditarParcela"
                            data-id="{{ parcela.id }}"
                            data-valor="{{ parcela.valor }}"
                            data-venciso="{{ parcela.data_vencimento_iso }}"
                            data-baixaiso="{{ parcela.data_baixa_iso }}"
                            data-status="{{ parcela.status_baixa }}">
                      Editar
                    </button>

                    <button type="button"
                            class="btn btn-sm btn-danger"
                            data-bs-toggle="modal"
                            data-bs-target="#modalExcluirParcela"
                            data-id="{{ parcela.id }}"
                            data-status="{{ parcela.status_baixa }}">
                      Excluir
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="11" class="text-center">Nenhum título encontrado.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {# === MODAIS DE COMPROVANTE (originais) === #}
  {% for titulo in page_obj %}
    {% for parcela in titulo.parcelas %}
      {% if parcela.id %}
      <div class="modal fade" id="modalAnexarComprovante{{ parcela.id }}" tabindex="-1" aria-labelledby="modalLabelAnexarComprovante{{ parcela.id }}" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLabelAnexarComprovante{{ parcela.id }}">
              {% if parcela.comprovante %} Alterar {% else %} Anexar {% endif %} Comprovante
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <form method="POST" action="{% url 'anexar_comprovante' parcela.id %}" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="mb-3">
                <label for="comprovante-{{ parcela.id }}" class="form-label">Selecione o Comprovante</label>
                <input type="file" class="form-control" id="comprovante-{{ parcela.id }}" name="comprovante" required>
              </div>
              <button type="submit" class="btn btn-primary">
                {% if parcela.comprovante %} Alterar {% else %} Anexar {% endif %} Comprovante
              </button>
            </form>
          </div>
        </div></div>
      </div>
      {% endif %}
    {% endfor %}
  {% endfor %}

  {# === MODAL ANEXAR CONTRATO (original) === #}
  {% for titulo in page_obj %}
  <div class="modal fade" id="modalAnexarContrato{{ titulo.titulo_id }}" tabindex="-1" aria-labelledby="modalLabelAnexarContrato{{ titulo.titulo_id }}" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabelAnexarContrato{{ titulo.titulo_id }}">Anexar Contrato</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{% url 'anexar_contrato' titulo.titulo_id %}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <label for="contrato-{{ titulo.titulo_id }}" class="form-label">Selecione o Contrato</label>
            <input type="file" class="form-control" id="contrato-{{ titulo.titulo_id }}" name="contrato" required>
          </div>
          <button type="submit" class="btn btn-primary">Anexar Contrato</button>
        </form>
      </div>
    </div></div>
  </div>
  {% endfor %}

  <!-- === MODAL EDITAR PARCELA (novo) === -->
  <div class="modal fade" id="modalEditarParcela" tabindex="-1" aria-labelledby="modalEditarParcelaLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formEditarParcela" method="post" action="{% url 'editar_parcela' 0 %}">
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header bg-warning">
            <h5 class="modal-title" id="modalEditarParcelaLabel">Editar parcela</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <div class="mb-3">
              <label class="form-label">Valor</label>
              <input type="text" inputmode="decimal" class="form-control" name="valor" id="edt_valor" required>
              <div class="form-text">Use vírgula para centavos (ex.: 123,45).</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Data de vencimento</label>
              <input type="date" class="form-control" name="data_vencimento" id="edt_venc" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select class="form-select" name="status_baixa" id="edt_status" required>
                <option value="0">Pendente</option>
                <option value="2">Quitado</option>
                <option value="3">Negociado</option>
              </select>
            </div>
            <div class="mb-0">
              <label class="form-label">Data de pagamento (se quitado)</label>
              <input type="date" class="form-control" name="data_baixa" id="edt_baixa">
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-warning" type="submit">Salvar</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- === MODAL EXCLUIR PARCELA (novo) === -->
  <div class="modal fade" id="modalExcluirParcela" tabindex="-1" aria-labelledby="modalExcluirParcelaLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formExcluirParcela" method="post" action="{% url 'excluir_parcela' 0 %}">
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="modalExcluirParcelaLabel">Excluir parcela</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <p class="mb-0">Tem certeza que deseja excluir esta parcela?</p>
            <small class="text-muted d-block">* Parcelas quitadas não podem ser excluídas.</small>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
            <button class="btn btn-danger" type="submit">Excluir</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Paginação -->
  <div class="d-flex justify-content-between align-items-center mt-3" style="font-size: 12px;">
    <div>
      {% if page_obj.has_previous %}
        <a href="?page=1{% if query %}&q={{ query }}{% endif %}" class="btn btn-sm btn-primary" style="font-size: 10px;">
          <i class="fas fa-angle-double-left"></i> Primeira
        </a>
        <a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-sm btn-secondary" style="font-size: 10px;">
          <i class="fas fa-angle-left"></i> Anterior
        </a>
      {% endif %}
    </div>
    <div><span>Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span></div>
    <div>
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-sm btn-secondary" style="font-size: 10px;">
          Próxima <i class="fas fa-angle-right"></i>
        </a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}" class="btn btn-sm btn-primary" style="font-size: 10px;">
          Última <i class="fas fa-angle-double-right"></i>
        </a>
      {% endif %}
    </div>
  </div>
</div>

<!-- Bootstrap 5 (uma única vez) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Scripts da página -->
<script>
  function toggleParcelas(tituloId){
    const row = document.getElementById(`parcelas-${tituloId}`);
    row.classList.toggle('d-none');
  }

  (function(){
    // EDITAR
    const modalEditar = document.getElementById('modalEditarParcela');
    modalEditar.addEventListener('show.bs.modal', function(ev){
      const btn   = ev.relatedTarget;
      const id    = btn.getAttribute('data-id');
      const valor = btn.getAttribute('data-valor') || '';
      const venc  = btn.getAttribute('data-venciso') || '';
      const baixa = btn.getAttribute('data-baixaiso') || '';
      const st    = btn.getAttribute('data-status') || '0';

      const form  = document.getElementById('formEditarParcela');
      form.action = form.action.replace(/\/0\/$/, `/${id}/`);

      document.getElementById('edt_valor').value = String(valor).replace('.', ',');
      document.getElementById('edt_venc').value  = venc;
      document.getElementById('edt_baixa').value = baixa;
      document.getElementById('edt_status').value = st;
    });
    modalEditar.addEventListener('hidden.bs.modal', function(){
      const form  = document.getElementById('formEditarParcela');
      form.action = form.action.replace(/\/\d+\/$/, '/0/');
      form.reset();
    });

    // EXCLUIR
    const modalExcluir = document.getElementById('modalExcluirParcela');
    modalExcluir.addEventListener('show.bs.modal', function(ev){
      const btn = ev.relatedTarget;
      const id  = btn.getAttribute('data-id');
      const st  = btn.getAttribute('data-status');

      const danger = modalExcluir.querySelector('button.btn-danger');
      if (String(st) === '2') {
        modalExcluir.querySelector('.modal-body').innerHTML =
          '<div class="alert alert-warning mb-0">Parcela quitada não pode ser excluída.</div>';
        danger.disabled = true;
      } else {
        modalExcluir.querySelector('.modal-body').innerHTML =
          '<p class="mb-0">Tem certeza que deseja excluir esta parcela?</p><small class="text-muted d-block">Esta ação não pode ser desfeita.</small>';
        danger.disabled = false;
      }

      const form = document.getElementById('formExcluirParcela');
      form.action = form.action.replace(/\/0\/$/, `/${id}/`);
    });
    modalExcluir.addEventListener('hidden.bs.modal', function(){
      const form = document.getElementById('formExcluirParcela');
      form.action = form.action.replace(/\/\d+\/$/, '/0/');
    });
  })();
</script>

{% endblock %}
