{% extends 'base.html' %}

{% block extra_styles %}
<style>
    /* Dashboard Styles */
    .dashboard-container {
        padding: 0;
    }

    /* Cards de Estatísticas */
    .stat-card {
        height: 100%;
        border: none;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
    }

    .stat-card:hover::before {
        left: 100%;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1) !important;
    }

    .stat-card .card-body {
    display: flex;
    flex-direction: column;
        justify-content: space-between;
        padding: 1rem;
        min-height: 100px;
    }

    .stat-card .stat-icon {
        font-size: 2rem;
        opacity: 0.3;
        transition: all 0.3s ease;
    }

    .stat-card:hover .stat-icon {
        opacity: 0.5;
        transform: scale(1.05);
    }

    .stat-card .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0.25rem 0;
        line-height: 1.2;
    }

    .stat-card .stat-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.9;
    }

    /* Seções */
    .dashboard-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid var(--line);
    }

    .section-title {
        font-size: 0.95rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
        color: var(--text);
    }

    .section-title i {
        font-size: 0.85rem;
    }

    /* Tabelas Responsivas */
    .table-responsive-custom {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .table-responsive-custom table {
        margin-bottom: 0;
        min-width: 600px;
    }

    @media (max-width: 768px) {
        .table-responsive-custom table {
            min-width: 500px;
        }
    }

    .table-responsive-custom thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .table-responsive-custom thead th {
        border: none;
        padding: 0.5rem;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.3px;
    }

    .table-responsive-custom tbody tr {
        transition: all 0.2s ease;
    }

    .table-responsive-custom tbody tr:hover {
        background-color: var(--brand-50);
    }

    .table-responsive-custom tbody td {
        padding: 0.5rem;
        vertical-align: middle;
        border-color: var(--line);
        font-size: 0.8rem;
    }

    .table-responsive-custom tbody td strong {
        font-weight: 600;
        font-size: 0.8rem;
    }

    /* Formulários de Busca */
    .search-form {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }

    .search-form .form-control {
        border-radius: 6px;
        border: 1px solid var(--line);
        padding: 0.4rem 0.6rem;
        font-size: 0.8rem;
        height: auto;
        transition: all 0.2s ease;
    }

    .search-form .form-control:focus {
        border-color: var(--brand-500);
        box-shadow: 0 0 0 0.1rem rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .search-form .form-control::placeholder {
        font-size: 0.75rem;
        color: var(--muted);
    }

    .search-form .btn {
        border-radius: 6px;
        padding: 0.4rem 0.8rem;
        font-weight: 500;
        font-size: 0.8rem;
        white-space: nowrap;
        transition: all 0.2s ease;
        min-width: auto;
    }

    .search-form .btn i {
        font-size: 0.75rem;
    }

    .search-form .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Badges */
    .badge {
        padding: 0.25rem 0.5rem;
        font-weight: 600;
        border-radius: 6px;
        font-size: 0.75rem;
    }

    /* Botões de Ação */
    .btn-action {
        margin: 0 0.125rem;
        border-radius: 5px;
        font-weight: 500;
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        transition: all 0.2s ease;
        white-space: nowrap;
        line-height: 1.2;
    }

    .btn-action i {
        font-size: 0.65rem;
        margin-right: 0.2rem;
    }

    .btn-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-sm {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }

    /* Modais */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .modal-header {
        border-bottom: 1px solid var(--line);
        border-radius: 12px 12px 0 0;
        padding: 1rem;
    }

    .modal-header .modal-title {
        font-size: 1rem;
    }

    .modal-body {
        padding: 1rem;
        font-size: 0.875rem;
    }

    .modal-footer {
        padding: 0.75rem 1rem;
    }

    /* Paginação */
    .pagination {
        margin-top: 0.75rem;
        margin-bottom: 0;
    }

    .pagination .page-item {
        margin: 0 0.1rem;
    }

    .page-link {
        border-radius: 5px;
        border: 1px solid var(--line);
        color: var(--text);
        font-size: 0.75rem;
        padding: 0.3rem 0.6rem;
        transition: all 0.2s ease;
        min-width: 2rem;
        text-align: center;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .page-link i {
        font-size: 0.65rem;
    }

    .page-link:hover {
        background-color: var(--brand-100);
        border-color: var(--brand-400);
        color: var(--brand-700);
        transform: translateY(-1px);
        text-decoration: none;
    }

    .page-item.active .page-link {
        background: var(--brand-500);
        border-color: var(--brand-500);
        color: white;
        font-weight: 600;
    }

    .page-item.disabled .page-link {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--muted);
    }

    .empty-state i {
        font-size: 2rem;
        opacity: 0.3;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        margin: 0;
        font-size: 0.875rem;
    }

    /* Animações */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stat-card {
        animation: fadeInUp 0.5s ease-out;
    }

    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    .stat-card:nth-child(4) { animation-delay: 0.4s; }
    .stat-card:nth-child(5) { animation-delay: 0.5s; }
    .stat-card:nth-child(6) { animation-delay: 0.6s; }
    .stat-card:nth-child(7) { animation-delay: 0.7s; }
    .stat-card:nth-child(8) { animation-delay: 0.8s; }

    /* Responsividade */
    @media (max-width: 992px) {
        .stat-card .card-body {
            padding: 0.75rem;
            min-height: 90px;
        }

        .stat-card .stat-value {
            font-size: 1.25rem;
        }

        .stat-card .stat-icon {
            font-size: 1.5rem;
        }

        .section-title {
            font-size: 1rem;
        }

        .table-responsive-custom thead th {
            padding: 0.5rem;
            font-size: 0.7rem;
        }

        .table-responsive-custom tbody td {
            padding: 0.5rem;
            font-size: 0.8rem;
        }
    }

    @media (max-width: 768px) {
        .stat-card .card-body {
            padding: 0.75rem;
            min-height: 80px;
        }

        .stat-card .stat-value {
            font-size: 1.1rem;
        }

        .stat-card .stat-icon {
            font-size: 1.25rem;
        }

        .stat-card .stat-label {
            font-size: 0.65rem;
        }

        .section-title {
            font-size: 0.85rem;
        }

        .table-responsive-custom {
            border-radius: 8px;
        }

        .table-responsive-custom thead th {
            padding: 0.4rem;
            font-size: 0.65rem;
        }

        .table-responsive-custom tbody td {
            padding: 0.4rem;
            font-size: 0.75rem;
        }

        .btn-action {
            font-size: 0.65rem;
            padding: 0.15rem 0.3rem;
            margin: 0.1rem;
        }

        .btn-action i {
            font-size: 0.6rem;
            margin-right: 0.15rem;
        }

        .search-form {
            padding: 0.5rem;
        }

        .search-form .form-control {
            font-size: 0.75rem;
            padding: 0.35rem 0.5rem;
        }

        .search-form .btn {
            font-size: 0.75rem;
            padding: 0.35rem 0.6rem;
        }

        .page-link {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            min-width: 1.75rem;
        }

        .dashboard-section {
            margin-top: 1rem;
            padding-top: 1rem;
        }
    }

    @media (max-width: 576px) {
        .stat-card .card-body {
            padding: 0.5rem;
            min-height: 70px;
        }

        .stat-card .stat-value {
            font-size: 1rem;
        }

        .stat-card .stat-label {
            font-size: 0.6rem;
        }

        .section-title {
            font-size: 0.8rem;
        }

        .table-responsive-custom thead th,
        .table-responsive-custom tbody td {
            padding: 0.35rem;
            font-size: 0.7rem;
        }

        .search-form {
            padding: 0.5rem;
        }

        .search-form .form-control {
            font-size: 0.7rem;
        }

        .search-form .btn {
            padding: 0.3rem 0.5rem;
            font-size: 0.7rem;
        }

        .btn-action {
            font-size: 0.6rem;
            padding: 0.15rem 0.25rem;
            margin: 0.1rem;
        }

        .page-link {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            min-width: 1.5rem;
        }

        .pagination {
            flex-wrap: wrap;
        }
    }

    /* Loading Spinner */
    .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Cards de Estatísticas -->
    <div class="row g-4 mb-4">
        <!-- Card Pendentes -->
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
            <div class="card stat-card shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                            <div class="stat-label">Pendentes</div>
                            <div class="stat-value count-number" data-count="{{ titulos_pendentes }}">0</div>
                    </div>
                        <i class="fas fa-file-alt stat-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Quitados -->
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
            <div class="card stat-card shadow-lg" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                            <div class="stat-label">Quitados</div>
                            <div class="stat-value count-number" data-count="{{ titulos_quitados }}">0</div>
                    </div>
                        <i class="fas fa-check-circle stat-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Negociados -->
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
            <div class="card stat-card shadow-lg" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                            <div class="stat-label">Negociados</div>
                            <div class="stat-value count-number" data-count="{{ titulos_negociados }}">0</div>
                    </div>
                        <i class="fas fa-handshake stat-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Total de Clientes -->
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
            <div class="card stat-card shadow-lg" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                            <div class="stat-label">Total de Clientes</div>
                            <div class="stat-value count-number" data-count="{{ total_clientes }}">0</div>
                    </div>
                        <i class="fas fa-users stat-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Negociados em Atraso -->
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
            <div class="card stat-card shadow-lg" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                            <div class="stat-label">Negociados em Atraso</div>
                            <div class="stat-value count-number" data-count="{{ negociados_em_atraso_count }}">0</div>
                    </div>
                        <i class="fas fa-exclamation-circle stat-icon"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Quitados Hoje -->
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
            <div class="card stat-card shadow-lg" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);" data-bs-toggle="modal" data-bs-target="#modalQuitadosHoje">
                <div class="card-body text-white">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                            <div class="stat-label">Quitados Hoje</div>
                            <div class="stat-value">R$ {{ quitados_hoje|floatformat:2 }}</div>
                    </div>
                        <i class="fas fa-calendar-check stat-icon"></i>
                    </div>
                    <small class="opacity-75"><i class="fas fa-info-circle me-1"></i>Clique para detalhes</small>
                </div>
            </div>
        </div>

        <!-- Card Negociados Hoje -->
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
            <div class="card stat-card shadow-lg" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333;" data-bs-toggle="modal" data-bs-target="#modalNegociadosHoje">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                            <div class="stat-label" style="color: #555;">Negociados Hoje</div>
                            <div class="stat-value" style="color: #333;">R$ {{ negociados_hoje|floatformat:2 }}</div>
                    </div>
                        <i class="fas fa-handshake stat-icon" style="color: #333; opacity: 0.3;"></i>
                    </div>
                    <small style="color: #666;"><i class="fas fa-info-circle me-1"></i>Clique para detalhes</small>
                </div>
            </div>
        </div>

        <!-- Card Ranking Operadores -->
        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6">
            <div class="card stat-card shadow-lg" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #333;" data-bs-toggle="modal" data-bs-target="#modalRankingOperadores">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                            <div class="stat-label" style="color: #555;">Ranking Operadores</div>
                            <div class="stat-value" style="color: #333; font-size: 1.5rem;">Ver Ranking</div>
                    </div>
                        <i class="fas fa-trophy stat-icon" style="color: #333; opacity: 0.3;"></i>
                    </div>
                    <small style="color: #666;"><i class="fas fa-info-circle me-1"></i>Clique para ver</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Script para contagem animada -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const counters = document.querySelectorAll('.count-number');
        const animateCounter = (counter, target, duration = 2000) => {
            const start = 0;
            const increment = target / (duration / 16);
            let current = start;

            const updateCounter = () => {
                current += increment;
                    if (current < target) {
                    counter.innerText = Math.floor(current);
                    requestAnimationFrame(updateCounter);
                    } else {
                        counter.innerText = target;
                    }
                };

            updateCounter();
        };

        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-count')) || 0;
            if (target > 0) {
                counter.innerText = '0';
                // Pequeno delay para melhor efeito visual
                setTimeout(() => animateCounter(counter, target), 100);
            } else {
                counter.innerText = '0';
            }
        });
    });
    </script>

    <!-- Modal para Quitados Hoje -->
    <div class="modal fade" id="modalQuitadosHoje" tabindex="-1" aria-labelledby="modalQuitadosHojeLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="modalQuitadosHojeLabel">
                        <i class="fas fa-check-circle me-2"></i>Detalhes dos Quitados Hoje
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if quitados_hoje_detalhes %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>CPF/CNPJ</th>
                                    <th>Empresa</th>
                                    <th>Data de Baixa</th>
                                        <th class="text-end">Valor Recebido</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in quitados_hoje_detalhes %}
                                    <tr>
                                            <td><strong>{{ item.nome }}</strong></td>
                                            <td>{{ item.cpf_cnpj|default:"-" }}</td>
                                        <td>{{ item.nome_fantasia }}</td>
                                            <td>{{ item.data_baixa|date:"d/m/Y" }}</td>
                                            <td class="text-end"><strong>R$ {{ item.valorRecebido|floatformat:2 }}</strong></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                        <p>Não há títulos quitados hoje.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById('modalQuitadosHoje');

        modal.addEventListener('show.bs.modal', function () {
            const modalBody = modal.querySelector('.modal-body');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';

            const quitadosHojeDetalhes = JSON.parse('{{ quitados_hoje_detalhes|safe }}');

            if (quitadosHojeDetalhes.length > 0) {
                let htmlContent = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF/CNPJ</th>
                                <th>Empresa</th>
                                <th>Data de Baixa</th>
                                <th>Valor Recebido</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                quitadosHojeDetalhes.forEach(item => {
                    htmlContent += `
                        <tr>
                            <td>${item.nome}</td>
                            <td>${item.cpf_cnpj || 'Não informado'}</td>
                            <td>${item.nome_fantasia}</td>
                            <td>${item.data_baixa}</td>
                            <td>${item.valorRecebido}</td>
                        </tr>
                    `;
                });

                htmlContent += '</tbody></table>';
                modalBody.innerHTML = htmlContent;
            } else {
                modalBody.innerHTML = '<p>Não há títulos quitados hoje.</p>';
            }
        });
    });
    </script>

    <!-- Modal para Negociados Hoje -->
    <div class="modal fade" id="modalNegociadosHoje" tabindex="-1" aria-labelledby="modalNegociadosHojeLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title fw-bold" id="modalNegociadosHojeLabel">
                        <i class="fas fa-handshake me-2"></i>Detalhes dos Negociados Hoje
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if negociados_hoje_detalhes %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>CPF/CNPJ</th>
                                    <th>Empresa</th>
                                    <th>Data de Negociação</th>
                                        <th class="text-end">Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in negociados_hoje_detalhes %}
                                    <tr>
                                            <td><strong>{{ item.nome }}</strong></td>
                                            <td>{{ item.cpf_cnpj|default:"-" }}</td>
                                        <td>{{ item.nome_fantasia }}</td>
                                            <td>{{ item.data_negociacao|date:"d/m/Y" }}</td>
                                            <td class="text-end"><strong>R$ {{ item.valor|floatformat:2 }}</strong></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                        <p>Não há títulos negociados hoje.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const modalNegociadosHoje = document.getElementById('modalNegociadosHoje');
        modalNegociadosHoje.addEventListener('show.bs.modal', function () {
            const modalBody = modalNegociadosHoje.querySelector('.modal-body');
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';

            const negociadosHojeDetalhes = JSON.parse('{{ negociados_hoje_detalhes|safe }}');
            if (negociadosHojeDetalhes.length > 0) {
                let htmlContent = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>CPF/CNPJ</th>
                                <th>Empresa</th>
                                <th>Data de Negociação</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                negociadosHojeDetalhes.forEach(item => {
                    htmlContent += `
                        <tr>
                            <td>${item.nome}</td>
                            <td>${item.cpf_cnpj || 'Não informado'}</td>
                            <td>${item.nome_fantasia}</td>
                            <td>${item.data_negociacao}</td>
                            <td>${item.valor}</td>
                        </tr>
                    `;
                });

                htmlContent += '</tbody></table>';
                modalBody.innerHTML = htmlContent;
            } else {
                modalBody.innerHTML = '<p>Não há títulos negociados hoje.</p>';
            }
        });
    });
    </script>

    <!-- Modal para Ranking Operadores -->
<div class="modal fade" id="modalRankingOperadores" tabindex="-1" aria-labelledby="modalRankingOperadoresLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
                <div class="modal-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h5 class="modal-title fw-bold" id="modalRankingOperadoresLabel">
                        <i class="fas fa-trophy me-2"></i>Ranking Operadores - Títulos Quitados
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros -->
                    <form id="filtroRankingForm" class="search-form mb-4">
                        <div class="row g-3">
                        <div class="col-md-4">
                                <label for="dataBaixaInicio" class="form-label fw-bold">Data de Baixa (Início)</label>
                            <input type="date" class="form-control" id="dataBaixaInicio" name="data_inicio">
                        </div>
                        <div class="col-md-4">
                                <label for="dataBaixaFim" class="form-label fw-bold">Data de Baixa (Fim)</label>
                            <input type="date" class="form-control" id="dataBaixaFim" name="data_fim">
                        </div>
                        <div class="col-md-4">
                                <label for="operadorFiltro" class="form-label fw-bold">Operador</label>
                            <select class="form-select" id="operadorFiltro" name="operador">
                                <option value="">Todos</option>
                                {% for usuario in usuarios %}
                                    <option value="{{ usuario.username }}">{{ usuario.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter me-2"></i>Filtrar
                                </button>
                            </div>
                        </div>
                </form>

                <!-- Total destacado -->
                    <div id="totalRanking" class="alert alert-success text-center mb-4 rounded-3 shadow-sm" style="display: none;">
                        <h4 class="alert-heading fw-bold mb-2">
                            <i class="fas fa-dollar-sign me-2"></i>Total Recebido
                        </h4>
                        <p class="fs-2 mb-0 fw-bold" id="valorTotal">R$ 0,00</p>
                </div>

                <!-- Resultados -->
                <div id="rankingResultados">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                            <p class="mt-3 text-muted">Carregando dados...</p>
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const modalRanking = document.getElementById('modalRankingOperadores');
    const formFiltro = document.getElementById('filtroRankingForm');
    const resultadosDiv = document.getElementById('rankingResultados');
    const totalDiv = document.getElementById('totalRanking');
    const valorTotalSpan = document.getElementById('valorTotal');

    function carregarRanking(dataInicio = '', dataFim = '', operador = '') {
        resultadosDiv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';
        totalDiv.style.display = 'none';

        fetch('/ranking-operadores/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                data_inicio: dataInicio,
                data_fim: dataFim,
                operador: operador
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.resultados && data.resultados.length > 0) {
                let htmlContent = `
                    <div class="table-responsive-custom">
                        <table class="table table-hover">
                        <thead>
                            <tr>
                                    <th style="width: 80px;">#</th>
                                <th>Operador</th>
                                    <th class="text-center">Total de Títulos Quitados</th>
                                    <th class="text-end">Valor Total Recebido</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.resultados.forEach((item, index) => {
                    const medalClass = index === 0 ? 'text-warning' : index === 1 ? 'text-secondary' : index === 2 ? 'text-danger' : '';
                    const medalIcon = index === 0 ? '<i class="fas fa-medal me-2"></i>' : index === 1 ? '<i class="fas fa-medal me-2"></i>' : index === 2 ? '<i class="fas fa-medal me-2"></i>' : '';
                    htmlContent += `
                        <tr>
                            <td><strong class="${medalClass}">${medalIcon}${item.posicao}º</strong></td>
                            <td><strong>${item.operador}</strong></td>
                            <td class="text-center"><span class="badge bg-primary">${item.total_titulos}</span></td>
                            <td class="text-end"><strong class="text-success">R$ ${item.total_valor_recebido.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></td>
                        </tr>
                    `;
                });

                htmlContent += '</tbody></table></div>';
                resultadosDiv.innerHTML = htmlContent;

                // Exibe o total
                totalDiv.style.display = 'block';
                valorTotalSpan.textContent = `R$ ${data.total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } else {
                resultadosDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>Nenhum operador encontrado para os filtros selecionados.</p>
                    </div>
                `;
                totalDiv.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            resultadosDiv.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    <p class="text-danger">Erro ao carregar os dados. Tente novamente.</p>
                </div>
            `;
            totalDiv.style.display = 'none';
        });
    }

    modalRanking.addEventListener('show.bs.modal', function () {
        carregarRanking();
    });

    formFiltro.addEventListener('submit', function (e) {
        e.preventDefault();
        const dataInicio = document.getElementById('dataBaixaInicio').value;
        const dataFim = document.getElementById('dataBaixaFim').value;
        const operador = document.getElementById('operadorFiltro').value;
        carregarRanking(dataInicio, dataFim, operador);
    });
});
</script>

    <!-- Agenda de trabalho do dia - Pendentes -->
    <div class="dashboard-section">
        <div class="search-form">
            <form method="get" action="{% url 'dashboard' %}" class="d-flex gap-2 align-items-center">
                <input type="text" name="query" class="form-control flex-grow-1" placeholder="Buscar por nome, CPF, CNPJ..." value="{{ query }}">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i>
                </button>
                {% if query %}
                <a href="{% url 'dashboard' %}" class="btn btn-secondary" title="Limpar busca">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </form>
        </div>

        <h2 class="section-title">
            <i class="fas fa-calendar-alt text-primary"></i>
            Agenda de Trabalho do Dia - Pendentes
    </h2>

        <div class="table-responsive-custom">
            <table class="table table-hover">
                <thead>
            <tr>
                <th>Devedor</th>
                <th>Credor</th>
                <th>Nome da Mãe</th>
                <th>Operador</th>
                <th>CPF/CNPJ</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for item in agenda_pendentes_paginated %}
            <tr>
                        <td>
                            <strong>
                    {% if item.nome and item.razao_social %}
                        {{ item.nome }} {{ item.razao_social }}
                    {% elif item.nome %}
                        {{ item.nome }}
                    {% elif item.razao_social %}
                        {{ item.razao_social }}
                    {% else %}
                                    -
                    {% endif %}
                            </strong>
                        </td>
                        <td><strong>{{ item.nome_fantasia_credor }}</strong></td>
                        <td>{{ item.nome_mae|default:'-' }}</td>
                        <td>{{ item.operador|default:'-' }}</td>
                        <td>
                            <strong>
                    {% if item.cpf %}
                        {{ item.cpf }}
                    {% elif item.cnpj %}
                        {{ item.cnpj }}
                    {% else %}
                        Não informado
                    {% endif %}
                            </strong>
                        </td>
                <td class="text-center">
                            <div class="d-flex flex-wrap gap-1 justify-content-center">
                                <a href="{% url 'detalhes_devedor' item.id %}" target="_blank" class="btn btn-sm btn-info btn-action" title="Visualizar">
                                    <i class="fas fa-eye"></i><span class="d-none d-md-inline ms-1">Ver</span>
                                </a>
                                <button class="btn btn-sm btn-success btn-action finalizar-btn" data-id="{{ item.id }}" title="Finalizar">
                                    <i class="fas fa-check"></i><span class="d-none d-md-inline ms-1">Finalizar</span>
                                </button>
                                <a href="{% url 'realizar_baixa' item.id %}" class="btn btn-sm btn-primary btn-action" title="Baixar">
                                    <i class="fas fa-download"></i><span class="d-none d-md-inline ms-1">Baixar</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p class="mb-0">Nenhum registro encontrado</p>
                            </div>
                        </td>
                    </tr>
            {% endfor %}
        </tbody>
    </table>
        </div>

        <!-- Paginação para Agenda de Pendentes -->
        {% if agenda_pendentes_paginated.has_other_pages %}
        <nav aria-label="Paginação de pendentes" class="mt-2">
            <ul class="pagination justify-content-center mb-0">
                {% if agenda_pendentes_paginated.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ agenda_pendentes_paginated.previous_page_number }}{% if query %}&query={{ query }}{% endif %}{% if data_inicio_negociados %}&data_inicio_negociados={{ data_inicio_negociados }}{% endif %}{% if data_fim_negociados %}&data_fim_negociados={{ data_fim_negociados }}{% endif %}" title="Página anterior">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                <li class="page-item active">
                    <span class="page-link">{{ agenda_pendentes_paginated.number }} / {{ agenda_pendentes_paginated.paginator.num_pages }}</span>
                </li>
                {% if agenda_pendentes_paginated.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ agenda_pendentes_paginated.next_page_number }}{% if query %}&query={{ query }}{% endif %}{% if data_inicio_negociados %}&data_inicio_negociados={{ data_inicio_negociados }}{% endif %}{% if data_fim_negociados %}&data_fim_negociados={{ data_fim_negociados }}{% endif %}" title="Próxima página">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    <!-- Agendamentos Pendentes -->
    <div class="dashboard-section">
        <h2 class="section-title">
            <i class="fas fa-tasks text-info"></i>
            Agendamentos Pendentes
    </h2>

    {% if agendamentos_hoje %}
        <div class="table-responsive-custom">
            <table class="table table-hover align-middle">
                <thead>
            <tr>
                <th>Devedor</th>
                <th>CPF / CNPJ</th>
                <th>Empresa</th>
                <th>Telefone</th>
                <th>Data de Retorno</th>
                <th>Operador</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for agendamento in agendamentos_hoje %}
            <tr>
                        <td><strong>{{ agendamento.devedor__nome }}</strong></td>
                        <td>
                            <strong>
                    {% if agendamento.devedor__cpf %}
                        {{ agendamento.devedor__cpf }}
                    {% elif agendamento.devedor__cnpj %}
                        {{ agendamento.devedor__cnpj }}
                    {% else %}
                        Não informado
                    {% endif %}
                            </strong>
                </td>
                        <td>{{ agendamento.empresa__nome_fantasia }}</td>
                        <td class="text-center">
                    {% if agendamento.telefone_formatado %}
                                <a href="https://wa.me/{{ agendamento.telefone_formatado }}" target="_blank" class="btn btn-sm btn-success btn-action">
                                    <i class="fab fa-whatsapp me-1"></i>
                            {{ agendamento.telefone_formatado }}
                        </a>
                            {% else %}
                                <span class="text-muted">-</span>
                    {% endif %}
                </td>
                        <td><strong>{{ agendamento.data_retorno|date:"d/m/Y H:i" }}</strong></td>
                        <td><strong>{{ agendamento.operador }}</strong></td>
                        <td class="text-center">
                            <div class="d-flex flex-wrap gap-1 justify-content-center">
                                <button type="button" class="btn btn-sm btn-info btn-action" data-bs-toggle="modal" data-bs-target="#modalAgendamento{{ agendamento.id }}" title="Visualizar">
                                    <i class="fas fa-eye"></i><span class="d-none d-md-inline ms-1">Ver</span>
                    </button>
                                <form method="POST" action="{% url 'finalizar_agendamento' agendamento.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-success btn-action" title="Finalizar">
                                        <i class="fas fa-check"></i><span class="d-none d-md-inline ms-1">Finalizar</span>
                                    </button>
                                </form>
                            </div>
                        </td>
            </tr>
            <!-- Modal -->
            <div class="modal fade" id="modalAgendamento{{ agendamento.id }}" tabindex="-1" aria-labelledby="modalLabel{{ agendamento.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title fw-bold" id="modalLabel{{ agendamento.id }}">
                                        <i class="fas fa-calendar-check me-2"></i>Detalhes do Agendamento
                                    </h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong class="text-muted">Devedor:</strong></p>
                                            <p class="fs-6">{{ agendamento.devedor__nome }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong class="text-muted">CPF/CNPJ:</strong></p>
                                            <p class="fs-6">{{ agendamento.devedor__cpf|default:agendamento.devedor__cnpj|default:"Não informado" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong class="text-muted">Empresa:</strong></p>
                                            <p class="fs-6">{{ agendamento.empresa__nome_fantasia }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong class="text-muted">Telefone:</strong></p>
                                            <p class="fs-6">{{ agendamento.telefone|default:"Não informado" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong class="text-muted">Data de Abertura:</strong></p>
                                            <p class="fs-6">{{ agendamento.data_abertura|date:"d/m/Y H:i" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong class="text-muted">Data de Retorno:</strong></p>
                                            <p class="fs-6">{{ agendamento.data_retorno|date:"d/m/Y H:i" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong class="text-muted">Operador:</strong></p>
                                            <p class="fs-6">{{ agendamento.operador }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p class="mb-2"><strong class="text-muted">Status:</strong></p>
                                            <p class="fs-6">
                                                <span class="badge {% if agendamento.status == 'Finalizado' %} bg-success {% else %} bg-warning text-dark {% endif %}">
                                                    {{ agendamento.status }}
                                                </span>
                                            </p>
                                        </div>
                                        <div class="col-12">
                                            <p class="mb-2"><strong class="text-muted">Assunto:</strong></p>
                                            <p class="fs-6">{{ agendamento.assunto|default:"Não informado" }}</p>
                                        </div>
                                    </div>
                        </div>
                        <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                        <i class="fas fa-times me-1"></i>Fechar
                                    </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </tbody>
    </table>
        </div>
    {% else %}
        <div class="empty-state">
            <i class="fas fa-calendar-times"></i>
            <p>Nenhum agendamento para hoje.</p>
        </div>
    {% endif %}
    </div>

    <!-- Negociados em Atraso -->
    <div class="dashboard-section">
        <h2 class="section-title">
            <i class="fas fa-exclamation-circle text-danger"></i>
            Negociados em Atraso
    </h2>

        <!-- Filtro de Data para Negociados em Atraso -->
        <form method="get" action="{% url 'dashboard' %}" class="search-form">
            <div class="row g-2 align-items-end">
                <div class="col-md-4 col-sm-6">
                    <label for="data_inicio_negociados" class="form-label small fw-bold mb-1">Data Início</label>
                    <input type="date" 
                           class="form-control form-control-sm" 
                           id="data_inicio_negociados" 
                           name="data_inicio_negociados" 
                           value="{{ data_inicio_negociados }}">
                </div>
                <div class="col-md-4 col-sm-6">
                    <label for="data_fim_negociados" class="form-label small fw-bold mb-1">Data Fim</label>
                    <input type="date" 
                           class="form-control form-control-sm" 
                           id="data_fim_negociados" 
                           name="data_fim_negociados" 
                           value="{{ data_fim_negociados }}">
                </div>
                <div class="col-md-4 col-sm-12">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        {% if data_inicio_negociados or data_fim_negociados %}
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-sm" title="Limpar filtro">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        <!-- Preservar outros parâmetros GET -->
        {% if query %}
        <input type="hidden" name="query" value="{{ query }}">
        {% endif %}
        {% if request.GET.page %}
        <input type="hidden" name="page" value="{{ request.GET.page }}">
        {% endif %}
    </form>

    {% if negociados_paginated %}
        <div class="table-responsive-custom">
            <table class="table table-hover">
        <thead>
            <tr>
                <th>Devedor</th>
                <th>Empresa</th>
                <th>Operador</th>
                <th>Data de Vencimento</th>
                <th>Valor</th>
                <th>Status</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for titulo in negociados_paginated %}
            <tr>
                        <td><strong>{{ titulo.devedor_nome }}</strong></td>
                <td>{{ titulo.empresa_nome }}</td>
                <td>{{ titulo.operador }}</td>
                <td>{{ titulo.data_vencimento|date:"d/m/Y" }}</td>
                        <td><strong>R$ {{ titulo.valor_total|floatformat:2 }}</strong></td>
                <td>
                            <span class="badge bg-warning text-dark">Negociado em atraso</span>
                </td>
                        <td class="text-center">
                            <div class="d-flex flex-wrap gap-1 justify-content-center">
                                <button class="btn btn-sm btn-primary btn-action alterar-operador-btn" data-id="{{ titulo.id }}" data-bs-toggle="modal" data-bs-target="#modalAlterarOperador" title="Mudar Operador">
                                    <i class="fas fa-user-edit"></i><span class="d-none d-md-inline ms-1">Operador</span>
                                </button>
                                <a href="{% url 'detalhes_devedor' titulo.id %}" target="_blank" class="btn btn-sm btn-info btn-action" title="Visualizar">
                                    <i class="fas fa-eye"></i><span class="d-none d-md-inline ms-1">Ver</span>
                                </a>
                                <button class="btn btn-sm btn-success btn-action finalizar-btn" data-id="{{ titulo.id }}" title="Finalizar">
                                    <i class="fas fa-check"></i><span class="d-none d-md-inline ms-1">Finalizar</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p class="mb-0">Nenhum título negociado em atraso encontrado.</p>
                            </div>
                        </td>
                    </tr>
            {% endfor %}
        </tbody>
    </table>
        </div>

    <!-- Modal de Seleção de Operador (fora do loop) -->
    <div class="modal fade" id="modalAlterarOperador" tabindex="-1" aria-labelledby="modalAlterarOperadorLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="modalAlterarOperadorLabel">
                        <i class="fas fa-user-edit me-2"></i>Selecionar Novo Operador
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="alterar-operador-form">
                        {% csrf_token %}
                        <input type="hidden" id="titulo-id" name="titulo_id">
                        <div class="mb-3">
                            <label for="operador" class="form-label fw-bold">Escolha um operador:</label>
                            <select class="form-select" id="operador" name="operador" required>
                                <option value="" disabled selected>Selecione um operador</option>
                                {% for usuario in usuarios %}
                                    <option value="{{ usuario.username }}">{{ usuario.username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="modal-footer px-0">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Salvar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        // Configurar botões de alterar operador
        document.querySelectorAll(".alterar-operador-btn").forEach(button => {
            button.addEventListener("click", function () {
                let tituloId = this.getAttribute("data-id");
                const tituloIdInput = document.getElementById("titulo-id");
                if (tituloIdInput) {
                    tituloIdInput.value = tituloId;
                }
            });
        });

        // Configurar formulário de alterar operador
        const alterarOperadorForm = document.getElementById("alterar-operador-form");
        if (alterarOperadorForm) {
            alterarOperadorForm.addEventListener("submit", function (event) {
                event.preventDefault();
                let tituloId = document.getElementById("titulo-id").value;
                let operador = document.getElementById("operador").value;
                let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

                if (!operador) {
                    alert("Por favor, selecione um operador.");
                    return;
                }

                if (!tituloId) {
                    alert("Erro: ID do título não encontrado.");
                    return;
                }

                fetch(`/alterar-operador/${tituloId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": csrfToken,
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: `operador=${operador}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(`Erro: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error("Erro na requisição:", error);
                    alert("Ocorreu um erro ao atualizar o operador.");
                });
            });
        }
    });
    </script>

    <!-- Paginação -->
        {% if negociados_paginated.has_other_pages %}
        <nav aria-label="Paginação de negociados" class="mt-2">
            <ul class="pagination justify-content-center mb-0">
                {% if negociados_paginated.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page_negociados={{ negociados_paginated.previous_page_number }}{% if data_inicio_negociados %}&data_inicio_negociados={{ data_inicio_negociados }}{% endif %}{% if data_fim_negociados %}&data_fim_negociados={{ data_fim_negociados }}{% endif %}{% if query %}&query={{ query }}{% endif %}" title="Página anterior">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                <li class="page-item active">
                    <span class="page-link">{{ negociados_paginated.number }} / {{ negociados_paginated.paginator.num_pages }}</span>
                </li>
                {% if negociados_paginated.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page_negociados={{ negociados_paginated.next_page_number }}{% if data_inicio_negociados %}&data_inicio_negociados={{ data_inicio_negociados }}{% endif %}{% if data_fim_negociados %}&data_fim_negociados={{ data_fim_negociados }}{% endif %}{% if query %}&query={{ query }}{% endif %}" title="Próxima página">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>Nenhum título negociado em atraso encontrado.</p>
        </div>
    {% endif %}
    </div>

    <!-- Modal para Detalhes -->
    <div class="modal fade" id="modalParcelamento{{ parcelamento.id }}" tabindex="-1" aria-labelledby="modalLabelParcelamento{{ parcelamento.id }}" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalLabelParcelamento{{ parcelamento.id }}">Detalhes da Parcela</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Parcela:</strong> {{ parcelamento.parcela_numero }}</p>
                    <p><strong>Valor:</strong> R$ {{ parcelamento.valor|floatformat:2 }}</p>
                    <p><strong>Data de Vencimento:</strong> {{ parcelamento.data_vencimento|date:"d/m/Y" }}</p>
                    <p><strong>Status:</strong> {{ parcelamento.status }}</p>
                    <p><strong>Devedor:</strong> {{ parcelamento.acordo.titulo.devedor.nome }}</p>
                    <p><strong>Empresa:</strong> {{ parcelamento.acordo.titulo.devedor.empresa.nome_fantasia }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Baixar -->
    <div class="modal fade" id="modalBaixarParcelamento{{ parcelamento.id }}" tabindex="-1" aria-labelledby="modalLabelBaixarParcelamento{{ parcelamento.id }}" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background-color: #39ff14;">
                    <h5 class="modal-title fw-bold text-dark" id="modalLabelBaixarParcelamento{{ parcelamento.id }}">
                        Baixar Parcela {{ parcelamento.parcela_numero }} / {{ parcelamento.qtde_prc }}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% if parcelamento.id %}
                    <form method="post" action="{% url 'pagar_parcela' parcelamento.id %}">
                    {% else %}
                    <p class="text-danger">ID da parcela não encontrado.</p>
                    {% endif %}
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="valorPago{{ parcelamento.id }}" class="form-label">Valor recebido</label>
                            <input type="number" step="0.01" class="form-control"
                                   id="valorPago{{ parcelamento.id }}"
                                   name="valor_pago"
                                   min="{{ parcelamento.valor|floatformat:2 }}"
                                   required>
                            <small class="text-muted">
                                <b>Valor mínimo permitido: R$ {{ parcelamento.valor|floatformat:2 }}</b>
                            </small>
                        </div>
                        <div class="mb-3">
                            <label for="dataBaixa{{ parcelamento.id }}" class="form-label">Data de Baixa</label>
                            <input type="date" class="form-control" id="dataBaixa{{ parcelamento.id }}" name="data_baixa" required>
                        </div>
                        <div class="mb-3">
                            <label for="formaPagamento{{ parcelamento.id }}" class="form-label">Forma de Pagamento</label>
                            <select class="form-select" id="formaPagamento{{ parcelamento.id }}" name="forma_pagamento" required>
                                <option value="">Selecione</option>
                                <option value="PIX">Pix</option>
                                <option value="BOLETO">Boleto</option>
                                <option value="DINHEIRO">Dinheiro</option>
                                <option value="CARTAO_CREDITO">Cartão de Crédito</option>
                                <option value="CARTAO_DEBITO">Cartão de Débito</option>
                                <option value="CHEQUE">Cheque</option>
                                <option value="PAGAMENTO_LOJA">Pagamento na Loja</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Confirmar Baixa</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Últimos clientes cadastrados -->
    <div class="dashboard-section">
        <h2 class="section-title">
            <i class="fas fa-users text-info"></i>
            Últimos Clientes Cadastrados
    </h2>

        <!-- Filtros para Últimos Clientes Cadastrados -->
        <form method="get" action="{% url 'dashboard' %}" class="search-form">
            <div class="row g-2 align-items-end">
                <div class="col-md-3 col-sm-6">
                    <label for="data_inicio_clientes" class="form-label small fw-bold mb-1">Data de Cadastro (Início)</label>
                    <input type="date" 
                           class="form-control form-control-sm" 
                           id="data_inicio_clientes" 
                           name="data_inicio_clientes" 
                           value="{{ data_inicio_clientes }}">
                </div>
                <div class="col-md-3 col-sm-6">
                    <label for="data_fim_clientes" class="form-label small fw-bold mb-1">Data de Cadastro (Fim)</label>
                    <input type="date" 
                           class="form-control form-control-sm" 
                           id="data_fim_clientes" 
                           name="data_fim_clientes" 
                           value="{{ data_fim_clientes }}">
                </div>
                <div class="col-md-3 col-sm-6">
                    <label for="lojista_id_clientes" class="form-label small fw-bold mb-1">Lojista</label>
                    <select class="form-select form-select-sm" id="lojista_id_clientes" name="lojista_id_clientes">
                        <option value="">Todos</option>
                        {% for lojista in lojistas %}
                            <option value="{{ lojista.id }}" {% if lojista_id_clientes|stringformat:"s" == lojista.id|stringformat:"s" %}selected{% endif %}>
                                {{ lojista.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 col-sm-12">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                            <i class="fas fa-filter"></i> Filtrar
                        </button>
                        {% if data_inicio_clientes or data_fim_clientes or lojista_id_clientes %}
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-sm" title="Limpar filtro">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Preservar outros parâmetros GET -->
            {% if query %}
            <input type="hidden" name="query" value="{{ query }}">
            {% endif %}
            {% if data_inicio_negociados %}
            <input type="hidden" name="data_inicio_negociados" value="{{ data_inicio_negociados }}">
            {% endif %}
            {% if data_fim_negociados %}
            <input type="hidden" name="data_fim_negociados" value="{{ data_fim_negociados }}">
            {% endif %}
            {% if request.GET.page %}
            <input type="hidden" name="page" value="{{ request.GET.page }}">
            {% endif %}
            {% if request.GET.page_negociados %}
            <input type="hidden" name="page_negociados" value="{{ request.GET.page_negociados }}">
            {% endif %}
        </form>

        <div class="table-responsive-custom">
            <table class="table table-hover">
                <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>CPF/CNPJ</th>
                <th>Data de Cadastro</th>
                <th>Lojista</th>
            </tr>
        </thead>
        <tbody>
            {% for cliente in ultimos_clientes %}
            <tr>
                        <td><strong>{{ cliente.id }}</strong></td>
                        <td><strong>{{ cliente.nome }}{{ cliente.nome_fantasia }}</strong></td>
                        <td>
                            <strong>
                                {% if cliente.cpf %}
                                    {{ cliente.cpf }}
                                {% elif cliente.cnpj %}
                                    {{ cliente.cnpj }}
                                {% else %}
                                    Não informado
                                {% endif %}
                            </strong>
                        </td>
                        <td><strong>{{ cliente.created_at|date:"d/m/Y" }}</strong></td>
                        <td><strong>{{ cliente.empresa__nome_fantasia|default:"-" }}</strong></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p class="mb-0">Nenhum cliente cadastrado recentemente.</p>
                            </div>
                        </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const finalizeButtons = document.querySelectorAll(".finalizar-btn");

    finalizeButtons.forEach(button => {
        button.addEventListener("click", function() {
            const tituloId = this.getAttribute("data-id");
            const url = `/finalizar-titulo/${tituloId}/`;

            if (confirm("Você tem certeza que deseja finalizar este título?")) {
                fetch(url, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json",
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === "success") {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error("Erro:", error);
                    alert("Ocorreu um erro ao finalizar o título.");
                });
            }
        });
    });
});
</script>

{% endblock %}